#!/bin/zsh

# Run command on all/selected devices:
# adb_all scrcpy --disable-screensaver --shortcut-mod=rctrl+lctrl
# adb_all adb shell getprop ro.build.version.sdk 
# serials="127.0.0.1:63874 127.0.0.1:63978" adb_all shell id
# adb_all adb shell ip --br -c a
 
null="/dev/null"

: ${serials:=$( adb devices 2>$null | tail -n+2 | cut -f 1)  }

for serial in $=serials; do 
	# real_serial=$( adb -s $serial shell getprop ro.serialno >& $null)
	real_serial=$( timeout 2 adb -s $serial shell getprop ro.serialno 2>$null )
	[[ -z $real_serial ]] && { 
		echo "$serial: Failed to get serial for $serial"
		continue
	}
	( eval ANDROID_SERIAL=$serial $* |& sed "s|^|$real_serial ($serial):\t|" ) &
done
wait

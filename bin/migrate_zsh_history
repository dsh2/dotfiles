#!/usr/bin/zsh 

migrate_zsh_history() {

	declare -r __zsh_history_base_dir=~/.logs/zsh/
	declare tmux_log=~/.tmux-log/

	fc -R ~/.zsh_history

	local -i zsh_history_id=$( print -P '%!' )
	# local -i zsh_history_id_fzf=$( cat $__zsh_history_base_dir/**/zsh_history_id(Om[1]) ) 
	# local -i zsh_history_id_fzf_youngest=$( cat $__zsh_history_base_dir/**/zsh_history_id(on[1]) )
	typeset -p zsh_history_id zsh_history_id_fzf zsh_history_id_fzf_youngest

	print "max_id=$( min $zsh_history_id $zsh_history_id_fzf )"
	print "diff=$(( zsh_history_id - zsh_history_id_fzf ))"

	set -x

	# local -i first=$zsh_history_id_fzf_youngest
	local -i first=1
	local -i last=$zsh_history_id

	(( first > last )) && step=-1 || step=1

	typeset -p first last step

	for i in $( seq $first $step $last ); do 
		fc -lt '%s' $i $i; done | 
			while read id date cmd; do 
				local log_dir=$( zsh_log_date_prefix $date )
				z3s "insert into history(zsh_history_id, date, command) value ($id, $date, $cmd)"
				local -i collision_idx=2
				while [[ -d $log_dir ]]; do
					old_cmd=$( < $log_dir/command_oneline )
					[[ $cmd == $old_cmd ]] && {
						print "Command already migrated: id=$id date=$date cmd=\"$cmd\""
						continue 2
					}
					local new_log_dir=$( zsh_log_date_prefix $date )-$collision_idx
					(( collision_idx++ ))
					print "Command collision: id=$id date=$date new=$new_log_dir cmd=\"$cmd\" old_cmd=\"$old_cmd\""
					typeset -p id date log_dir new_log_dir cmd old_cmd
					log_dir=$new_log_dir
				done
				mkdir -p $log_dir && cd $log_dir
				print -R $cmd > command > command_oneline
				print $id > zsh_history_id
				echo $date > date_start_epoch
				date --date @$date '+%F %T' > date_start
				gz=$tmux_log/$id.gz
				norm=$tmux_log/$id
				if [[ -e $gz ]]; then
					output="gz"
					cp $gz output.gz
				elif [[ -e $norm ]]; then
					output="norm"
					gzip < $norm > $log_dir/output.gz
				else
					output="[no output]"
				fi
				print "Command migrated: id=$id date=$date output=$output log_dir=$log_dir cmd=\"$cmd\""
				# ls -dl $log_dir
				# ls -Al 
			done
}
set -x
migrate_zsh_history

#!/bin/zsh -e

# This script hibernates a computer after some idle time

# Install with:
# sudo sh -c "( crontab -l ; echo @reboot /usr/sbin/load_hibernation; ) | crontab -"

warn() { echo "[*] $*" >&2; }
now_epoch() { date '+%s'; }
sleep_time=2
unloaded_duration=$(( 60 * 60 ))  # in seconds

loaded_timestamp=$( now_epoch )
logger -s "Monitoring system for excess idle time ($unloaded_duration seconds)."

while :; do
	set $(cat /proc/loadavg); load=$1
	if [ -z "$load" ]; then
		logger -s "Failed to acquire load measure."
	else
		(( $load > 1.1 )) && {
			(( idle_time > 0 )) && logger -s "System becomes loaded."
			loaded_timestamp=$( now_epoch )
		}
	fi
	idle_time=$(( $( now_epoch ) - loaded_timestamp ))
	(( idle_time > 0 && idle_time <= sleep_time )) && logger -s "System is idle."
	(( idle_time > unloaded_duration )) && {
		logger -s "Hibernating system due to excess idle time."
		systemctl hibernate
		sleep 5
		loaded_timestamp=$( now_epoch )
	}
	sleep $sleep_time
done
